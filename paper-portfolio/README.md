# paper-portfolio: Portfolio Construction & Performance Evaluation 📈

`paper-portfolio` is a key component of the P.A.P.E.R (Platform for Asset Pricing Experimentation and Research) monorepo. It provides a powerful, configuration-driven framework for constructing investment portfolios based on the predictive outputs of machine learning models and evaluating their economic significance.

Using the prediction files generated by `paper-model`, this package allows you to backtest various long-short portfolio strategies, calculate standard performance metrics, and generate insightful reports and visualizations.

---

## ✨ Features

*   **Flexible Portfolio Construction:**
    *   **Long-Short Strategies:** Easily construct long-short portfolios by sorting assets based on their predicted returns.
    *   **Quantile-Based Selection:** Define portfolios by selecting assets from specific quantiles (e.g., long top 10%, short bottom 10%). Supports flexible quantile ranges (e.g., long 90-95%, short 5-10%) to manage tail risk.
    *   **Multiple Weighting Schemes:** Supports both **Equal-Weighted (EQ)** and **Value-Weighted (VW)** portfolio construction.
*   **Comprehensive Performance Metrics:**
    *   **Annualized Sharpe Ratio:** Evaluate risk-adjusted returns.
    *   **Expected Shortfall (ES / CVaR):** Measure the portfolio's tail risk and expected loss in worst-case scenarios.
    *   **Cumulative Return:** Track the growth of the portfolio over the entire backtesting period.
*   **Configuration-Driven Workflow:** Define all your portfolio strategies, the models to test, and the metrics to calculate in a single, human-readable `portfolio-config.yaml` file. This ensures reproducibility and simplifies experimentation.
*   **Seamless Integration:** Directly consumes the `.parquet` prediction files produced by the `paper-model` component, creating a smooth end-to-end research pipeline.
*   **Automated Reporting:**
    *   Generates detailed text reports summarizing the performance metrics for each model and strategy combination.
    *   Automatically creates and saves plots for cumulative returns, providing a clear visual comparison of strategy performance over time.
*   **Integrated Logging:** All operations are logged to the project's central `logs.log` file, offering transparency for debugging and auditing without cluttering the console.

---

## 🚀 Installation

`paper-portfolio` is designed to be part of the larger `PAPER` monorepo. You can install it as an optional dependency of `paper-tools` or as a standalone package.

**Recommended (as part of `paper-tools`):**

If you have `paper-tools` installed, you can get `paper-portfolio` and its dependencies using the `portfolio` extra:

```bash
pip install paper-tools[portfolio]
# Or if using uv:
uv add paper-tools[portfolio]
```

**Standalone Installation:**

If you only need `paper-portfolio` and its core functionalities, you can install it directly:

```bash
pip install paper-portfolio
# Or if using uv:
uv add paper-portfolio
```

**From Source (for development within the monorepo):**

Navigate to the root of your `PAPER` monorepo and install `paper-portfolio` in editable mode:

```bash
cd /path/to/your/PAPER_monorepo
uv pip install -e ./paper-portfolio
```

---

## 📖 Usage Example: Evaluating Model Predictions

This example demonstrates how to use `paper-portfolio` to construct and evaluate portfolios based on the prediction files generated by `paper-model`.

### 1. Prerequisite: Run the Model Pipeline

Before running the portfolio phase, you must first run the data and model pipelines to generate the necessary inputs. This will create the processed datasets and, most importantly, the prediction files in `models/predictions/`.

```bash
# Assuming you are in the monorepo root
# And your project is named 'ModelExample'

# Run the data phase
paper execute data --project-path ModelExample

# Run the models phase
paper execute models --project-path ModelExample
```

After these steps, your project's `models/predictions/` directory should contain files like `elastic_net_model_predictions.parquet`.

### 2. Portfolio Configuration (`portfolio-config.yaml`)

Create or edit the `portfolio-config.yaml` file in your project's `configs` directory (e.g., `ModelExample/configs/portfolio-config.yaml`). This file defines which models to test and which portfolio strategies to apply.

```yaml
# ModelExample/configs/portfolio-config.yaml

input_data:
  # List of model names whose predictions you want to evaluate.
  # These must match the names used in models-config.yaml.
  prediction_model_names:
    - "ff_3_predictor_ols"
    - "elastic_net_model"
    - "pcr_model"
  
  # The base name of the processed dataset used by the models.
  processed_dataset_name: "final_dataset_model"
  
  # Column names required for calculations.
  date_column: "date"
  id_column: "permno"
  risk_free_rate_col: "rf"
  value_weight_col: "bm" # Column used for value-weighting (e.g., book-to-market)

# A list of portfolio strategies to backtest for each model.
strategies:
  - name: "EQ90"
    weighting_scheme: "equal"
    long_quantiles: [0.9, 1.0]   # Long the top 10% of predicted returns
    short_quantiles: [0.0, 0.1]  # Short the bottom 10%

  - name: "VAL90"
    weighting_scheme: "value"
    long_quantiles: [0.9, 1.0]
    short_quantiles: [0.0, 0.1]

  - name: "EQ95"
    weighting_scheme: "equal"
    long_quantiles: [0.90, 0.95] # Long the 90th-95th percentile
    short_quantiles: [0.05, 0.10] # Short the 5th-10th percentile

  - name: "VAL95"
    weighting_scheme: "value"
    long_quantiles: [0.90, 0.95]
    short_quantiles: [0.05, 0.10]

# A list of performance metrics to calculate and report.
metrics:
  - "sharpe_ratio"
  - "expected_shortfall"
  - "cumulative_return"
```

### 3. Running the Portfolio Pipeline

You can run the portfolio pipeline using the `paper-portfolio`'s standalone `run_pipeline.py` script or, preferably, through the `paper-tools` orchestrator.

**Using `paper-tools` (Recommended):**

```bash
# Assuming you are in the monorepo root
paper execute portfolio --project-path ModelExample
```

**Using the Standalone Script:**

```bash
# Assuming you are in the monorepo root
python paper-portfolio/src/paper_portfolio/run_pipeline.py
```

### 4. Expected Output

**Console Output:**

The console will show a high-level summary of the process.

```
>>> Executing Portfolio Phase <<<
Auto-detected project root: /path/to/your/PAPER_monorepo/ModelExample
Portfolio phase completed successfully. Additional information in '/path/to/your/PAPER_monorepo/ModelExample/logs.log'
```

**`ModelExample/portfolios/results/` Directory:**

After a successful run, the `results` directory will be populated with detailed reports and plots for each model-strategy combination.

```
ModelExample/portfolios/results/
├── elastic_net_model_EQ90_cumulative_return.png
├── elastic_net_model_EQ90_monthly_returns.parquet
├── elastic_net_model_EQ90_report.txt
├── elastic_net_model_EQ95_cumulative_return.png
├── elastic_net_model_EQ95_monthly_returns.parquet
├── elastic_net_model_EQ95_report.txt
├── elastic_net_model_VAL90_cumulative_return.png
├── ... (and so on for all models and strategies)
```

**Example Report (`elastic_net_model_EQ90_report.txt`):**

```
--- Portfolio Performance Report ---
Model: elastic_net_model
Strategy: EQ90
------------------------------
sharpe_ratio: 1.3900
expected_shortfall: -0.0250
final_cumulative_return: 7.5400
------------------------------
```

---

## ⚙️ Configuration Reference

The `portfolio-config.yaml` file controls the entire portfolio evaluation process.

### `input_data`

*   `prediction_model_names` (list of strings, required): A list of model names. The manager will look for prediction files named `{model_name}_predictions.parquet` in the `models/predictions/` directory.
*   `processed_dataset_name` (string, required): The base name of the processed dataset that was used for modeling. This is needed to fetch additional columns like the risk-free rate and value-weighting characteristic.
*   `date_column` (string, optional, default: `"date"`): The name of the date column.
*   `id_column` (string, optional, default: `"permno"`): The name of the firm identifier column.
*   `risk_free_rate_col` (string, optional, default: `"rf"`): The name of the risk-free rate column, required for calculating the Sharpe Ratio.
*   `value_weight_col` (string, optional, default: `"bm"`): The name of the column to use for value-weighting (e.g., book-to-market ratio, market cap).

### `strategies`

A list of portfolio strategies to backtest. Each strategy is an object with the following keys:

*   `name` (string, required): A unique name for the strategy (e.g., `"VAL95"`).
*   `weighting_scheme` (string, required): The method for weighting assets in the portfolio. Must be either `"equal"` or `"value"`.
*   `long_quantiles` (list of two floats, required): The lower and upper quantile boundaries for the long leg of the portfolio. E.g., `[0.9, 1.0]` for the top 10%.
*   `short_quantiles` (list of two floats, required): The lower and upper quantile boundaries for the short leg. E.g., `[0.0, 0.1]` for the bottom 10%.

### `metrics`

A list of performance metrics to compute for each strategy.

*   Supported values: `"sharpe_ratio"`, `"expected_shortfall"`, `"cumulative_return"`.

---

## 🤝 Contributing

Contributions to `paper-portfolio` are highly welcome! If you have ideas for new performance metrics, portfolio construction techniques, or reporting features, please follow these steps:

1.  Fork the repository.
2.  Create a new branch (`git checkout -b feature/YourFeature`).
3.  Implement your changes and add tests if applicable.
4.  Commit your changes (`git commit -am 'Add new feature'`).
5.  Push to the branch (`git push origin feature/YourFeature`).
6.  Open a Pull Request.

---

## 📄 License

`paper-portfolio` is distributed under the MIT License. See the `LICENSE` file for more information.

---